<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>KS?QL Quickstart</title>
    <script>
        var rawResponseBody = '';
        var xhr = new XMLHttpRequest();

        var renderFunction = renderTabular;
        var streamedResponse = false;

        function sendRequest(resource) {
            xhr.abort();

            var ksql = document.getElementById('ksql').value;

            xhr.onreadystatechange = function() {
                if (xhr.response !== '' && (xhr.readyState === 3 || xhr.readyState === 4)) {
                    rawResponseBody = xhr.response;
                    renderResponse();
                }
                if (xhr.readyState === 4 || xhr.readyState === 0) {
                    document.getElementById("request_loading").hidden = true;
                    document.getElementById("cancel_request").hidden = true;
                }
            };

            var data = JSON.stringify({'ksql': ksql});

            document.getElementById("cancel_request").hidden = false;
            document.getElementById("request_loading").hidden = false;
            xhr.open('POST', resource);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(data);
        }

        function cancelRequest() {
            var responseElement = document.getElementById('response');
            var response = responseElement.innerHTML;
            xhr.abort();
            responseElement.innerHTML = response;
        }

        function renderResponse() {
            var renderedBody = '';
            if (streamedResponse) {
                var parsingError = false;
                var splitBody = rawResponseBody.split('\n');
                // Have to leave the last line off, as it may be an incomplete
                // JSON blob, which would just cause parsing errors
                for (var i = 0; i < splitBody.length - 1; i++) {
                    var line = splitBody[i].trim();
                    if (line !== '') {
                        try {
                            var parsedJson = JSON.parse(line);
                            renderedBody += renderFunction(parsedJson);
                        } catch (SyntaxError) {
                          // Only want to alert them the first time an error
                          // is encountered, since there could be a lot
                          if (!parsingError) {
                            alert('Error parsing response JSON');
                          }
                          parsingError = true;
                          renderedBody += line;
                        }
                        renderedBody += '\n';
                    }
                }
                if (rawResponseBody.endsWith('\n')) {
                  // We can safely try to render the last line
                  var lastLine = splitBody[splitBody.length - 1].trim();
                  if (lastLine !== '') {
                    renderedBody += renderFunction(lastLine) + '\n';
                  }
                }
            } else {
                renderedBody = renderFunction(rawResponseBody);
            }
            document.getElementById('response').innerHTML = renderedBody;
        }

        function renderTabular(parsedBody) {
           return 'TODO';
        }

        function renderPrettyJson(parsedBody) {
            return JSON.stringify(parsedBody, null, 2);
        }

        function renderCompactJson(parsedBody) {
            return JSON.stringify(parsedJson);
        }

        function updateFormat(newRenderFunction) {
          renderFunction = newRenderFunction;
          if (rawResponseBody !== '') {
            renderResponse();
          }
        }
    </script>
    <style>
        .request {
            width:100%;
            height:100px;

            font-size:20px;
            font-family:monospace;
        }

        .loading {
          animation: pulse 2s infinite;
        }

        @keyframes pulse {
          0% {
            opacity: 0.1;
          }
          50% {
            opacity: 1;
          }
          100% {
            opacity: 0.1;
          }
        }

        .response {
            width:100%;
            height:1000px;

            overflow-y:scroll;

            border:2px solid gray;

            font-size:20px;
        }
    </style>
</head>
<body>
    KSQL:
    <br />
    <textarea class="request" id="ksql"></textarea>
    <br />
    <br />
    <br />
    <button onclick="streamedResponse = false; sendRequest('/ksql');">Send Request!</button>
        &nbsp;&nbsp;(examples: "LIST STREAMS;", "SHOW QUERIES;", "CREATE STREAM foo AS SELECT baz FROM bar;")
    <br />
    <br />
    <button onclick="streamedResponse = true; sendRequest('/query');">Stream a query!</button>
        &nbsp;&nbsp;(example: "SELECT * FROM foo;", "PRINT topic_foo;")
    <br />
    <br />
    <span class="loading" id="request_loading" hidden>Request loading...</span>
    <button hidden id="cancel_request" onclick="xhr.abort();">Cancel request...</button>
    <br />
    <br />
    <br />
    Server response:
    <br />
    <br />
    Output format:
        <label>
            <input checked type="radio" name="output" value="tabular" onchange="updateFormat(renderTabular);"> Tabular
        </label>
        <label>
            <input type="radio" name="output" value="prettyjson" onchange="updateFormat(renderPrettyJson);"> JSON (pretty)
        </label>
        <label>
            <input type="radio" name="output" value="compactjson" onchange="updateFormat(renderCompactJson);"> JSON (compact)
        </label>
    <br />
    <br />
    <pre id="response" class="response"></pre>
</body>
</html>
